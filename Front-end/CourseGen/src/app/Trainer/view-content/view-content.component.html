<div class="admin-dashboard-container">

  <div *ngIf="selectedCourse" class="course-container" [class.shifted]="isCollapsed">
    <div class="course-header">
      <h2>{{ courseName }}</h2>

      <!-- Displaying units -->
      <div *ngIf="units && units.length > 0; else noUnits" class="course-content">
        <div *ngFor="let unit of units" class="unit-card" [attr.data-unit-id]="unit?.unitId">
          <h4 class="unit-header" [ngClass]="{ collapsed: !unit?.isExpanded }" (click)="toggleUnit(unit)">
            {{ unit?.unitName || 'Unnamed Unit' }}
            <i class="fas" [class.fa-chevron-down]="unit?.unitName && !expandedUnits[unit.unitName]"
              [class.fa-chevron-up]="unit?.unitName && expandedUnits[unit.unitName]"></i>
          </h4>

          <ul *ngIf="unit?.isExpanded" class="unit-content">
            <li class="topic">
              <div *ngIf="isString(unit?.content); else arrayContent">
                <p [innerHTML]="parseLinksAndBold(unit.content)">{{ unit?.content }}</p>
              </div>
              <ng-template #arrayContent>
                <ul>
                  <li *ngFor="let item of asArray(unit?.content)">
                    <ng-container *ngIf="isCodeBlock(item); else subItems" class="code-block">
                      <pre><code [attr.language]="item.language">{{ item.code }}</code></pre>
                    </ng-container>
                    <ng-template #subItems>
                      <ng-container *ngIf="hasSubItems(item); else plainText">
                        <strong>{{ item.text }}</strong>
                        <ul>
                          <li *ngFor="let subItem of item.subItems">{{ subItem }}</li>
                        </ul>
                      </ng-container>
                      <ng-template #plainText>
                        <span>{{ item }}</span>
                      </ng-template>
                    </ng-template>
                  </li>
                </ul>
              </ng-template>
            </li>
            <button title="Regenerate Unit" (click)="openRegenerateForm(unit); $event.stopPropagation()" class="re-generate-button">üîÑ</button>
          </ul>
        </div>
      </div>

      <ng-template #loading>
        <p>Loading...</p>
      </ng-template>


      <ng-template #noUnits>
        <p>No units available or still loading...</p>
      </ng-template>


      <!-- Modal for Regeneration Reason -->
      <!-- Move this outside the course-container div but still inside admin-dashboard-container -->
      <div class="modal-overlay" *ngIf="isRegenerateModalVisible">
        <div class="modal-content">
          <h3>Regenerate Unit: {{ selectedUnits?.unitName || 'Unknown Unit' }}</h3>
          <form (ngSubmit)="submitRegenerationForm()">
            <label for="reason">Why do you want to regenerate this unit?</label>
            <textarea 
              id="reason" 
              name="reason" 
              [(ngModel)]="regenerationReason" 
              required
              placeholder="Enter your reason">
            </textarea>
            <div class="modal-actions">
              <button type="button" class="cancel-button"  (click)="closeRegenerateForm()">Cancel</button>
              <button 
                type="submit"
                class="confirm-button" 
                [disabled]="!regenerationReason || isRegenerating">
                {{ isRegenerating ? 'Regenerating...' : 'Submit' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    
      <!-- Loading Overlay -->
      <div class="loading-overlay" *ngIf="isRegenerating">
        <div class="loader">
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
        </div>
        <p class="loading-text">Regenerating content...</p>
      </div>
    
      <!-- Your existing download button -->
      <button class="download-button" (click)="downloadPDF()" [disabled]="!units || units.length === 0">
        ‚¨áÔ∏è Download PDF
      </button>

      <ng-template #noUnits>
        <p>No units available for this course.</p>
      </ng-template>
    </div>
  </div>

  <!-- <button class="download-button" (click)="downloadPDF()" [disabled]="!units || units.length === 0">‚¨áÔ∏è Download
    PDF</button> -->
  <!-- <button class="re-generate-button" (click)="showRegenerateForm()">üîÑ Re-Generate Content</button> -->


  <div class="floating-button" *ngIf="showFloatingButton" [style.top]="buttonPosition.top"
    [style.left]="buttonPosition.left">
    <button class="regenerate-button" (click)="regenerateSelection()">
      <i class="fas fa-sync-alt"></i>
      Regenerate
    </button>
  </div>
  <div class="modal-overlay" *ngIf="isModalVisible">
    <div class="modal-content">
      <h3 class="modal-title">Review Generated Text</h3>

      <div class="text-section">
        <div class="text-label">Original Text:</div>
        <div class="text-content">
          {{ highlightedText }}
        </div>
      </div>

      <div class="text-section">
        <div class="text-label">Regenerated Text:</div>
        <div class="text-content">
          {{ regeneratedText }}
        </div>
      </div>

      <div class="modal-actions">
        <button class="cancel-button" (click)="isModalVisible = false">Cancel</button>
        <button class="confirm-button" (click)="confirmUpdate()">Confirm Update</button>
      </div>
    </div>
  </div>

</div>